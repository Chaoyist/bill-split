<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å¸³å°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg relative flex flex-col">
        
        <!-- Header -->
        <header class="bg-slate-800 text-white p-4 flex justify-between items-center sticky top-0 z-50 shadow-md">
            <div class="flex items-center gap-2">
                <button v-if="currentView !== 'projectList' && !loading" @click="goBack" class="text-white text-xl pr-2 hover:text-gray-300">â†</button>
                <div>
                    <h1 class="text-lg font-bold tracking-wide">{{ headerTitle }}</h1>
                    <p v-if="currentProject" class="text-xs text-blue-200">{{ currentProject.name }}</p>
                </div>
            </div>
            <div v-if="user" class="flex items-center gap-2">
                <img :src="user.pictureUrl || 'https://via.placeholder.com/30'" class="w-8 h-8 rounded-full border-2 border-slate-600">
            </div>
        </header>

        <!-- DIAGNOSTIC PANEL (DEBUG) -->
        <div class="bg-black text-green-400 p-2 text-[10px] font-mono break-all overflow-hidden" v-if="debugInfo">
            <p><strong>SRC:</strong> {{ debugInfo.source }}</p>
            <p><strong>GID:</strong> {{ debugInfo.groupId }}</p>
            <p v-if="debugInfo.source === 'URL_PARAM'" class="text-yellow-300">âœ… å·²é–å®šçœŸå¯¦ç¾¤çµ„ ID</p>
            <p v-else-if="debugInfo.isUuid" class="text-red-400">âš ï¸ UUID æ¨¡å¼ (è³‡æ–™ç„¡æ³•ä¿å­˜)</p>
        </div>

        <!-- Loading -->
        <div v-if="loading" class="absolute inset-0 bg-white/95 z-40 flex flex-col items-center justify-center">
            <div class="loader mb-3"></div>
            <p class="text-sm text-gray-500 font-medium">{{ loadingText }}</p>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-4 pb-24 overflow-y-auto">
            
            <!-- Error Alert -->
            <div v-if="error" class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-4 relative rounded-r shadow-sm">
                <strong class="font-bold block mb-1">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</strong>
                <span class="block text-sm break-all font-mono bg-red-100 p-1 rounded mb-2">{{ error }}</span>
                <div v-if="isNetworkError" class="text-xs text-red-800 bg-red-100 p-2 rounded border border-red-200">
                    <p class="font-bold mb-1">ğŸ’¡ é¡§å•è¨ºæ–·ï¼šé€£ç·šè¢«æ‹’çµ•</p>
                    <p>é€™é€šå¸¸æ˜¯ç¶²è·¯æˆ–æ¬Šé™å•é¡Œï¼Œè«‹å˜—è©¦ï¼š</p>
                    <ol class="list-decimal ml-4 mt-1 space-y-1">
                        <li>ç¢ºèª GAS éƒ¨ç½²æ¬Šé™ç‚º <strong>ã€Œæ‰€æœ‰äººã€</strong>ã€‚</li>
                        <li>å®Œå…¨é—œé–‰ LINE App å†é‡æ–°é–‹å•Ÿã€‚</li>
                    </ol>
                </div>
                <button @click="error = null" class="absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold">Ã—</button>
            </div>

            <!-- VIEW 1: PROJECT LIST -->
            <div v-if="currentView === 'projectList'">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-gray-600 font-bold">æˆ‘çš„ç¾¤çµ„å¸³æœ¬</h2>
                    <button @click="openCreateProject" class="bg-blue-600 text-white px-4 py-1.5 rounded-full text-sm font-medium shadow hover:bg-blue-700 transition flex items-center gap-1">
                        <span>+</span> æ–°å¢å¸³æœ¬
                    </button>
                </div>
                <div v-if="projects.length === 0 && !loading" class="text-center py-12 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
                    <p class="text-lg mb-2">ğŸ“­</p>
                    <p>é€™è£¡ç›®å‰ç©ºç©ºå¦‚ä¹Ÿ</p>
                </div>
                <div class="grid gap-3">
                    <div v-for="p in projects" :key="p.id" @click="enterProject(p)" 
                        :class="{'opacity-75 bg-gray-50 border-gray-300 border-l-gray-400': p.status === 'settled', 'bg-white border-l-blue-500': p.status !== 'settled'}"
                        class="border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer active:scale-[0.98] border-l-4 relative overflow-hidden">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">{{ p.name }}</h3>
                                <p class="text-xs text-gray-400 mt-1">{{ formatDate(p.timestamp) }} å»ºç«‹</p>
                            </div>
                            <span v-if="p.status === 'settled'" class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full font-medium">å·²çµæ¡ˆ</span>
                            <span v-else class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full font-medium">é€²è¡Œä¸­</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: CREATE PROJECT -->
            <div v-if="currentView === 'createProject'">
                <h2 class="text-xl font-bold mb-6 text-gray-800">å»ºç«‹æ–°å¸³æœ¬</h2>
                <form @submit.prevent="submitCreateProject" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•åç¨±</label>
                        <input v-model="newProjectName" type="text" required class="w-full rounded-lg border-gray-300 border p-3 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼š2026 æ±äº¬æ»‘é›ªåœ˜">
                    </div>
                    <div class="pt-4 space-y-3">
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition">ç¢ºèªå»ºç«‹</button>
                        <button type="button" @click="currentView = 'projectList'" class="w-full bg-white border border-gray-300 text-gray-500 py-3 rounded-lg hover:bg-gray-50 transition">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>

            <!-- VIEW 3: EXPENSE LIST -->
            <div v-if="currentView === 'expenseList'">
                <div v-if="!isMember" class="bg-yellow-50 border-yellow-200 border rounded-lg p-4 mb-4 flex flex-col items-center text-center gap-2 shadow-sm">
                    <p class="text-yellow-800 font-bold text-sm">ä½ é‚„ä¸æ˜¯é€™å€‹å¸³æœ¬çš„æˆå“¡</p>
                    <button @click="joinProject" class="bg-yellow-500 text-white px-6 py-2 rounded-full font-bold text-sm shadow hover:bg-yellow-600 transition w-full mt-1">ğŸ‘‹ æˆ‘è¦åŠ å…¥</button>
                </div>

                <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-xs text-gray-500 flex flex-col">
                        <span>ç¸½æ”¯å‡º</span>
                        <span class="text-gray-900 font-bold text-lg">${{ totalExpense }}</span>
                    </div>
                    <!-- åªæœ‰æœªçµæ¡ˆæ‰èƒ½è¨˜å¸³ -->
                    <button v-if="isMember && currentProject.status !== 'settled'" @click="openAddExpense" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 text-sm font-bold flex items-center gap-1">
                        âœï¸ è¨˜ä¸€ç­†
                    </button>
                    <span v-else-if="currentProject.status === 'settled'" class="text-xs bg-gray-200 text-gray-500 px-3 py-1 rounded-full font-bold">å·²é–å®š</span>
                </div>

                <div v-if="expenses.length === 0" class="text-center text-gray-400 py-12">
                    <p>å°šç„¡æ”¯å‡ºç´€éŒ„</p>
                </div>

                <div v-for="exp in expenses" :key="exp.id" class="bg-white border border-gray-100 rounded-xl p-3 mb-3 shadow-sm flex justify-between items-start">
                    <div class="flex gap-3 flex-1">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl overflow-hidden shrink-0 mt-1">
                            <img v-if="users[exp.payerId]?.pictureUrl" :src="users[exp.payerId].pictureUrl" class="w-full h-full object-cover">
                            <span v-else>ğŸ‘¤</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="font-bold text-gray-800 text-base line-clamp-1">{{ exp.item }}</div>
                                <div class="font-mono text-lg font-bold text-green-600 shrink-0 ml-2">${{ exp.amount }}</div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                {{ getUserName(exp.payerId) }} ä»˜æ¬¾ â€¢ {{ formatDate(exp.timestamp) }}
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1 line-clamp-2">
                                åˆ†æ“”: {{ getSplitNames(exp.splitMembers) }}
                            </div>
                        </div>
                    </div>
                    <!-- æ¬Šé™æ§åˆ¶ï¼šåªæœ‰è‡ªå·±çš„ç´€éŒ„ & æœªçµæ¡ˆæ™‚å¯ç·¨è¼¯ (ä¾è³´ creatorId) -->
                    <div v-if="canEdit(exp) && currentProject.status !== 'settled'" class="flex flex-col gap-2 ml-2 pl-2 border-l border-gray-100 justify-center">
                        <button @click="editExpense(exp)" class="text-gray-400 hover:text-blue-500 p-1">âœï¸</button>
                        <button @click="confirmDelete(exp)" class="text-gray-400 hover:text-red-500 p-1">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: ADD/EDIT EXPENSE -->
            <div v-if="currentView === 'addExpense'">
                <h2 class="text-xl font-bold mb-4 text-gray-800">{{ formMode === 'edit' ? 'ç·¨è¼¯æ”¯å‡º' : 'æ–°å¢æ”¯å‡º' }}</h2>
                <form @submit.prevent="submitExpense" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label>
                        <input v-model="form.item" type="text" required class="w-full rounded-lg border-gray-300 border p-2.5 focus:ring-2 focus:ring-green-500 outline-none" placeholder="ä¾‹ï¼šæ™šé¤ã€é«˜éµç¥¨">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡</label>
                        <input v-model.number="form.amount" type="number" required class="w-full rounded-lg border-gray-300 border p-2.5 focus:ring-2 focus:ring-green-500 outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èª°å…ˆä»˜ï¼Ÿ</label>
                        <select v-model="form.payerId" class="w-full rounded-lg border-gray-300 border p-2.5 bg-white">
                            <option v-for="(u, id) in users" :value="id">{{ u.displayName }}</option>
                        </select>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">èª°è¦åˆ†æ“”ï¼Ÿ ({{ form.splitMembers.length }})</label>
                            <button type="button" @click="selectAllMembers" class="text-xs text-blue-500 font-medium">å…¨é¸</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-1">
                            <div v-for="(u, id) in users" :key="id" 
                                @click="toggleSplitMember(id)"
                                :class="{'bg-green-50 border-green-500 ring-1 ring-green-500': form.splitMembers.includes(id), 'bg-white border-gray-200': !form.splitMembers.includes(id)}"
                                class="p-2 border rounded-lg cursor-pointer text-sm flex items-center gap-2 transition-all select-none">
                                <img :src="u.pictureUrl || 'https://via.placeholder.com/20'" class="w-6 h-6 rounded-full shrink-0">
                                <span class="truncate">{{ u.displayName }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 grid grid-cols-2 gap-3">
                        <button type="button" @click="currentView = 'expenseList'" class="bg-gray-100 text-gray-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
                        <button type="submit" class="bg-green-600 text-white py-3 rounded-lg font-bold shadow hover:bg-green-700 transition">{{ formMode === 'edit' ? 'æ›´æ–°' : 'å„²å­˜' }}</button>
                    </div>
                </form>
            </div>

            <!-- VIEW 5: SETTLE -->
            <div v-if="currentView === 'settle'">
                <h2 class="text-xl font-bold mb-4 text-gray-800">çµç®—æ–¹æ¡ˆ</h2>
                
                <div v-if="currentProject.status !== 'settled'" class="bg-blue-50 text-blue-800 p-4 rounded-xl text-sm mb-4 border border-blue-100 shadow-sm">
                    <p class="font-bold mb-1">ğŸ’¡ æœ€ä½³é‚„æ¬¾è·¯å¾‘</p>
                    <p class="text-blue-600 text-xs">ç³»çµ±å·²è‡ªå‹•è¨ˆç®—æœ€å°è½‰å¸³æ¬¡æ•¸ã€‚</p>
                </div>
                <div v-else class="bg-gray-100 text-gray-600 p-4 rounded-xl text-sm mb-4 border border-gray-200 shadow-sm flex items-center gap-2">
                    <span>ğŸ”’</span>
                    <span class="font-bold">æ­¤å°ˆæ¡ˆå·²çµæ¡ˆ</span>
                </div>

                <div v-if="settlement.length === 0" class="text-center py-12 text-gray-400 bg-white rounded-xl border border-dashed">
                    <p class="text-2xl mb-2">ğŸ‰</p>
                    <p>å¸³ç›®å·²çµæ¸…ï¼Œç„¡éœ€è½‰å¸³ï¼</p>
                </div>

                <div v-for="(tx, idx) in settlement" :key="idx" class="bg-white border border-gray-100 rounded-xl p-4 mb-3 shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-3 text-sm flex-1">
                        <div class="flex flex-col items-center min-w-[3rem]">
                            <span class="font-bold text-gray-800 truncate max-w-[4rem]">{{ getUserName(tx.from) }}</span>
                            <span class="text-[10px] text-red-500">ä»˜æ¬¾è€…</span>
                        </div>
                        <div class="text-gray-300">âœ</div>
                        <div class="flex flex-col items-center min-w-[3rem]">
                            <span class="font-bold text-gray-800 truncate max-w-[4rem]">{{ getUserName(tx.to) }}</span>
                            <span class="text-[10px] text-green-500">æ”¶æ¬¾è€…</span>
                        </div>
                    </div>
                    <div class="font-mono text-xl font-bold text-blue-600">${{ tx.amount }}</div>
                </div>

                <!-- ACTIONS -->
                <div class="mt-6 space-y-3">
                    <button @click="sendSettlement" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold shadow hover:bg-green-600 flex justify-center items-center gap-2">
                        <span>ğŸ“¢</span> å‚³é€çµç®—åˆ°ç¾¤çµ„
                    </button>
                    
                    <button v-if="currentProject.status !== 'settled'" @click="confirmCloseProject" class="w-full bg-white border border-gray-300 text-gray-500 py-3 rounded-lg font-bold hover:bg-gray-50 flex justify-center items-center gap-2">
                        <span>ğŸ”’</span> çµæ¡ˆ (é–å®šå¸³æœ¬)
                    </button>
                </div>
            </div>

        </main>

        <!-- Bottom Nav -->
        <nav v-if="['expenseList', 'settle'].includes(currentView)" class="bg-white border-t flex justify-around p-2 z-30 pb- safe-area-bottom">
            <button @click="currentView = 'expenseList'" :class="{'text-green-600 scale-110': currentView === 'expenseList'}" class="flex flex-col items-center p-2 text-gray-400 transition-all">
                <span class="text-xl mb-0.5">ğŸ“</span>
                <span class="text-[10px]">æ˜ç´°</span>
            </button>
            <button @click="fetchSettlement" :class="{'text-blue-600 scale-110': currentView === 'settle'}" class="flex flex-col items-center p-2 text-gray-400 transition-all">
                <span class="text-xl mb-0.5">âš–ï¸</span>
                <span class="text-[10px]">çµç®—</span>
            </button>
        </nav>
    </div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

const LIFF_ID = "2009031450-O3r9jaRJ"; 
// âš ï¸ å·²ç¶“é–å®šï¼Œçµ•ä¸æ›´æ”¹
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwJD0Qzvb4cw7Hss2U6J-ATTHnQU0Pml6-gyQUE4osX_lXEiFG18HuQ_bR_o3didgxR1Q/exec"; 

createApp({
    setup() {
        const loading = ref(true);
        const loadingText = ref('å•Ÿå‹•ä¸­...');
        const error = ref(null);
        
        const currentView = ref('projectList');
        const user = ref(null);
        const context = ref(null);
        const currentGroupId = ref('');
        const debugInfo = ref(null); 

        const projects = ref([]);
        const currentProject = ref(null);
        const expenses = ref([]);
        const users = ref({});
        const memberIds = ref([]);
        const settlement = ref([]);

        const newProjectName = ref('');
        const formMode = ref('add');
        const form = ref({ id: null, item: '', amount: '', payerId: '', splitMembers: [] });

        const headerTitle = computed(() => {
            const map = { projectList: 'åˆ†å¸³å°å¹«æ‰‹', createProject: 'å»ºç«‹æ´»å‹•', expenseList: 'å¸³æœ¬æ˜ç´°', addExpense: formMode.value === 'edit' ? 'ç·¨è¼¯æ”¯å‡º' : 'æ–°å¢æ”¯å‡º', settle: 'çµç®—' };
            return map[currentView.value] || 'åˆ†å¸³å°å¹«æ‰‹';
        });

        const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
        
        const isMember = computed(() => {
            if (!user.value || !memberIds.value) return false;
            return memberIds.value.includes(user.value.userId);
        });

        const isNetworkError = computed(() => {
            if (!error.value) return false;
            const msg = error.value.toLowerCase();
            return msg.includes('load failed') || msg.includes('failed to fetch') || msg.includes('network error');
        });

        const formatDate = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getMonth()+1}/${d.getDate()}`;
        };

        const getUserName = (id) => users.value[id]?.displayName || 'æœªçŸ¥';
        
        const getSplitNames = (ids) => {
            if (!ids || ids.length === 0) return 'ç„¡';
            if (ids.length === Object.keys(users.value).length && ids.length > 0) return 'å…¨å“¡';
            return ids.map(id => getUserName(id)).join(', ');
        };

        const callApi = async (action, payload) => {
            try {
                // ç°¡åŒ– Fetch (å…¼å®¹æ‰‹æ©Ÿç‰ˆ)
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, payload })
                });
                const data = await response.json();
                if (data.status === 'error') throw new Error(data.message);
                return data;
            } catch (err) {
                console.error("API Error:", err);
                error.value = err.message;
                throw err;
            }
        };

        const initLiff = async () => {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                user.value = await liff.getProfile();
                context.value = liff.getContext();
                
                const urlParams = new URLSearchParams(window.location.search);
                const urlGroupId = urlParams.get('groupId');
                const ctx = context.value || {};
                const liffGroupId = ctx.groupId || ctx.roomId;
                
                let finalGid = urlGroupId || liffGroupId;
                let idSource = urlGroupId ? 'URL_PARAM' : 'LIFF_CONTEXT';

                currentGroupId.value = finalGid;
                debugInfo.value = { source: idSource, groupId: finalGid, isUuid: /^[0-9a-f]{8}-[0-9a-f]{4}/.test(finalGid || '') };
                
                if (!finalGid) { error.value = "è­¦å‘Šï¼šç„¡æ³•å–å¾—ç¾¤çµ„ IDã€‚è«‹ç¢ºèªä½ æ˜¯é»æ“Šæ©Ÿå™¨äººçš„æŒ‰éˆ•é€²å…¥ã€‚"; }

                if (finalGid) {
                    await callApi('syncUser', { userId: user.value.userId, displayName: user.value.displayName, pictureUrl: user.value.pictureUrl, groupId: finalGid });
                    await fetchProjects(finalGid);
                }
            } catch (err) {
                error.value = "åˆå§‹åŒ–å¤±æ•—: " + err.message;
            } finally {
                loading.value = false;
            }
        };

        const fetchProjects = async (gid) => {
            loading.value = true;
            try {
                const res = await callApi('getProjects', { groupId: gid });
                projects.value = res.projects;
                currentView.value = 'projectList';
            } finally { loading.value = false; }
        };

        const openCreateProject = () => { currentView.value = 'createProject'; };
        const submitCreateProject = async () => {
            if (!newProjectName.value) return;
            loading.value = true;
            try {
                await callApi('createProject', { name: newProjectName.value, ownerId: user.value.userId, boundGroupId: currentGroupId.value });
                newProjectName.value = '';
                await fetchProjects(currentGroupId.value);
            } finally { loading.value = false; }
        };

        const enterProject = async (project) => {
            currentProject.value = project;
            loading.value = true;
            loadingText.value = "è¼‰å…¥ä¸­...";
            try {
                const res = await callApi('getProjectDetails', { projectId: project.id });
                expenses.value = res.expenses;
                users.value = res.users;
                memberIds.value = res.memberIds || [];
                currentView.value = 'expenseList';
            } finally { loading.value = false; }
        };

        const joinProject = async () => {
            loading.value = true;
            try {
                await callApi('joinProject', { projectId: currentProject.value.id, userId: user.value.userId });
                await enterProject(currentProject.value);
            } finally { loading.value = false; }
        };

        const openAddExpense = () => {
            formMode.value = 'add';
            form.value = { id: null, item: '', amount: '', payerId: user.value.userId, splitMembers: memberIds.value || [] };
            currentView.value = 'addExpense';
        };

        const editExpense = (exp) => {
            formMode.value = 'edit';
            form.value = { 
                id: exp.id, 
                item: exp.item, 
                amount: exp.amount, 
                payerId: exp.payerId, 
                splitMembers: exp.splitMembers || [] 
            };
            currentView.value = 'addExpense';
        };

        const submitExpense = async () => {
            if (form.value.splitMembers.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ“”æˆå“¡"); return; }
            loading.value = true;
            try {
                const action = formMode.value === 'edit' ? 'updateExpense' : 'addExpense';
                await callApi(action, {
                    id: form.value.id,
                    projectId: currentProject.value.id,
                    payerId: form.value.payerId,
                    amount: form.value.amount,
                    item: form.value.item,
                    splitMembers: form.value.splitMembers,
                    creatorId: user.value.userId // å‚³éå»ºç«‹è€… ID
                });
                await enterProject(currentProject.value);
            } finally { loading.value = false; }
        };

        const confirmDelete = async (exp) => {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${exp.item}ã€å—ï¼Ÿ`)) return;
            loading.value = true;
            try {
                await callApi('deleteExpense', { id: exp.id });
                await enterProject(currentProject.value);
            } finally { loading.value = false; }
        };
        
        const fetchSettlement = async () => {
            loading.value = true;
            try {
                const res = await callApi('settle', { projectId: currentProject.value.id });
                settlement.value = res.transactions;
                currentView.value = 'settle';
            } finally { loading.value = false; }
        };

        const confirmCloseProject = async () => {
            if(!confirm("ç¢ºå®šè¦çµæ¡ˆå—ï¼Ÿçµæ¡ˆå¾Œå°‡ç„¡æ³•æ–°å¢æˆ–ä¿®æ”¹æ”¯å‡ºã€‚")) return;
            loading.value = true;
            try {
                await callApi('closeProject', { projectId: currentProject.value.id });
                await fetchProjects(currentGroupId.value);
                currentView.value = 'projectList';
            } finally { loading.value = false; }
        };

        const sendSettlement = async () => {
            loading.value = true;
            try {
                await callApi('sendSettlementToGroup', { 
                    projectId: currentProject.value.id,
                    projectName: currentProject.value.name 
                });
                alert("å·²ç™¼é€åˆ°ç¾¤çµ„ï¼");
            } finally { loading.value = false; }
        };

        const goBack = () => {
            if (['addExpense', 'settle'].includes(currentView.value)) currentView.value = 'expenseList';
            else { currentView.value = 'projectList'; currentProject.value = null; }
        };

        // æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰å»ºç«‹è€…(å„ªå…ˆ)æˆ–ä»˜æ¬¾äºº(èˆŠè³‡æ–™)å¯ä»¥ä¿®æ”¹
        const canEdit = (exp) => {
            if (!user.value) return false;
            if (exp.creatorId) return exp.creatorId === user.value.userId;
            return exp.payerId === user.value.userId;
        };

        const toggleSplitMember = (uid) => {
            const idx = form.value.splitMembers.indexOf(uid);
            if (idx > -1) form.value.splitMembers.splice(idx, 1);
            else form.value.splitMembers.push(uid);
        };
        const selectAllMembers = () => { form.value.splitMembers = Object.keys(users.value); }

        onMounted(() => { initLiff(); });

        return {
            loading, loadingText, error, isNetworkError, debugInfo, currentView, user, currentGroupId,
            projects, currentProject, expenses, users, settlement, isMember,
            newProjectName, form, formMode, headerTitle, totalExpense,
            formatDate, getUserName, getSplitNames, canEdit, goBack, 
            openCreateProject, submitCreateProject, enterProject, joinProject, 
            openAddExpense, editExpense, confirmDelete, submitExpense,
            toggleSplitMember, selectAllMembers, fetchSettlement,
            confirmCloseProject, sendSettlement
        };
    }
}).mount('#app');
</script>
</body>
</html>
